<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaseMeme Layer Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- CUSTOM COLORS --- */
        :root {
            --color-dark-bg: #302c44;
            --color-accent: #547cf4;
            --color-primary-action: #4362e5;
            --color-general-button: #a09bc5;
            --color-dark-accent: #0e1f72;
            --color-white: #FFFFFF;
            --color-black: #000000;
            --color-selection-red: #ff3838;
            --color-section-bg: #3c3852; 
        }

        /* --- –õ–û–ö–ê–õ–¨–ù–´–ï –®–†–ò–§–¢–´: –¢–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ JS --- */
        /* –ë—Ä–∞—É–∑–µ—Ä—ã –∑–∞–≥—Ä—É–∑—è—Ç —ç—Ç–∏ —à—Ä–∏—Ñ—Ç—ã, –∫–æ–≥–¥–∞ JS –¥–∞—Å—Ç –∫–æ–º–∞–Ω–¥—É */
        @font-face { font-family: 'AppGlobalFont'; src: url('./fonts/font4.otf') format('opentype'); }
        @font-face { font-family: 'LocalFont1'; src: url('./fonts/font1.ttf') format('truetype'); }
        @font-face { font-family: 'LocalFont2'; src: url('./fonts/font2.ttf') format('truetype'); }
        @font-face { font-family: 'LocalFont3'; src: url('./fonts/font3.ttf') format('truetype'); }

        /* --- BASE STYLES --- */
        body {
            font-family: 'AppGlobalFont', sans-serif;
            background-color: var(--color-dark-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Canvas and Handles (kept for functionality) */
        .canvas-container { position: relative; display: inline-block; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); background-color: var(--color-white); transition: transform 0.3s ease; }
        #memeCanvas { display: block; touch-action: none; }
        #drawingCanvas { position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none; }
        #drawingCanvas.active-drawing { pointer-events: auto; cursor: crosshair; }
        #resizeHandle { position: absolute; bottom: -15px; right: -15px; width: 30px; height: 30px; background-color: var(--color-accent); border: 3px solid var(--color-white); border-radius: 50%; cursor: nwse-resize; z-index: 20; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); touch-action: none; }
        .layer-handle { position: absolute; width: 20px; height: 20px; background-color: var(--color-selection-red); border: 3px solid var(--color-white); border-radius: 50%; cursor: nwse-resize; z-index: 15; box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); touch-action: none; display: none; transform: translate(-50%, -50%); }
        .selected-item { border-width: 4px; border-color: var(--color-accent) !important; }
        
        /* [UI/Layout styles kept for context] */
        .control-button { transition: all 0.15s ease-in-out; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); color: var(--color-black); background-color: var(--color-general-button); }
        .control-button:hover { transform: translateY(-1px); background-color: #8c90b6; }
        .primary-action-button { background-color: var(--color-primary-action); color: var(--color-white); }
        .primary-action-button:hover { background-color: var(--color-dark-accent); }
        #preview-wrapper { width: 100%; display: flex; justify-content: center; align-items: center; flex-grow: 1; padding: 1rem; position: relative; }
        #main-controls-fab { position: fixed; bottom: 20px; right: 20px; z-index: 30; background-color: var(--color-accent); color: var(--color-white); border-radius: 50%; width: 60px; height: 60px; font-size: 24px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4); transition: background-color 0.15s; }
        #main-controls-fab:hover { background-color: var(--color-primary-action); }
        .app-drawer-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 40; display: none; }
        .app-drawer-content { position: absolute; top: 0; right: 0; width: 100%; max-width: 400px; height: 100%; background-color: var(--color-dark-bg); box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5); transform: translateX(100%); transition: transform 0.3s ease-out; padding: 1rem; overflow-y: auto; }
        .app-drawer-container.active { display: block; }
        .app-drawer-container.active .app-drawer-content { transform: translateX(0); }
        .secondary-panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--color-dark-bg); transform: translateX(100%); transition: transform 0.3s ease-out; padding: 1rem; overflow-y: auto; }
        .secondary-panel.active { transform: translateX(0); }
        @media (min-width: 1024px) {
            body { height: 100vh; overflow: hidden; flex-direction: row; }
            #main-controls-fab { display: none; }
            .app-drawer-container { position: static; width: 33.3333%; height: 100%; display: block !important; background-color: transparent; order: 1; z-index: 20; }
            .app-drawer-content { position: static; width: 100%; max-width: none; height: 100%; transform: translateX(0); box-shadow: none; padding-bottom: 6rem; }
            .secondary-panel { position: absolute; height: 100%; z-index: 50; }
            #preview-wrapper { width: 66.6667%; height: 100vh; order: 2; overflow: auto; }
            .sticky-footer { position: sticky; bottom: 0; left: 0; width: 100%; background-color: var(--color-dark-bg); padding: 1rem 0; border-top: 1px solid var(--color-accent); }
        }
    </style>
</head>
<body>

    <div id="preview-wrapper">
        <div id="preview" class="w-full flex items-center justify-center relative">
            <div id="canvas-container" class="canvas-container rounded-xl shadow-2xl">
                <canvas id="memeCanvas" class="touch-none"></canvas>
                <canvas id="drawingCanvas" class="touch-none"></canvas>
                <div id="resizeHandle"></div>
                <div id="layerResizeHandle" class="layer-handle"></div> 
            </div>
        </div>
    </div>

    <div id="main-controls-fab" onclick="toggleMainDrawer()">
        ‚öôÔ∏è
    </div>

    <div id="app-drawer-container" class="app-drawer-container">
        <div id="app-drawer-content" class="app-drawer-content">
            <div class="flex justify-between items-center border-b border-[--color-accent] pb-3 mb-4 sticky top-0 bg-[--color-dark-bg] z-50 pt-2">
                <h1 class="text-2xl font-extrabold text-[--color-accent]">üõ†Ô∏è BaseMeme Studio</h1>
                <button onclick="toggleMainDrawer()" class="text-white text-2xl p-2 rounded-full hover:bg-[--color-dark-accent]">
                    &times; 
                </button>
            </div>
            
            <p class="text-sm text-gray-200 mb-4" id="baseAppStatus">BaseApp Status: Connecting...</p>
            
            <div id="main-menu" class="space-y-3">
                
                <button onclick="openSecondaryPanel('templates')" class="control-button w-full py-3 font-bold rounded-lg text-lg flex justify-between items-center">
                    <span>üñºÔ∏è Background & Templates</span>
                    <span>></span>
                </button>
                
                <button onclick="openSecondaryPanel('stickers')" class="control-button w-full py-3 font-bold rounded-lg text-lg flex justify-between items-center">
                    <span>‚ú® Stickers & Items</span>
                    <span>></span>
                </button>
                
                <button onclick="openSecondaryPanel('text')" class="control-button w-full py-3 font-bold rounded-lg text-lg flex justify-between items-center">
                    <span>üÖ∞Ô∏è Text & Fonts</span>
                    <span>></span>
                </button>
                
                <button onclick="openSecondaryPanel('drawing')" class="control-button w-full py-3 font-bold rounded-lg text-lg flex justify-between items-center">
                    <span>‚úèÔ∏è Drawing Tool</span>
                    <span>></span>
                </button>
                
                <hr class="border-[--color-accent] my-4">

                <h2 class="text-xl font-bold text-[--color-accent] pt-2">Selected Layer: <span id="currentLayerTypeDisplay">None</span></h2>
                
                <div id="contextualControls" class="space-y-4">
                     <div id="commonControls" class="hidden space-y-3">
                        <button onclick="deleteSelectedLayer()" class="control-button w-full py-3 rounded bg-red-500 hover:bg-red-600 text-white font-bold">
                            üóëÔ∏è Delete Selected Layer
                        </button>
                    </div>
                    
                    <div id="transformationControls" class="space-y-4 hidden p-3 rounded-lg bg-[--color-section-bg]">
                        <h3 class="text-lg font-semibold text-white">Transformations</h3>
                        <div>
                            <label for="rotationSlider" class="block text-sm font-medium text-white">
                                Rotation: <span id="rotationValue">0¬∞</span>
                            </label>
                            <input type="range" id="rotationSlider" min="0" max="360" step="1" value="0" class="w-full h-2 bg-[--color-accent] rounded-lg appearance-none cursor-pointer range-lg" oninput="updateRotation(event.target.value)">
                        </div>
                        <div class="flex flex-wrap items-center gap-3">
                            <button id="flipXBtn" onclick="toggleFlip('flipX')" class="control-button px-3 py-2 rounded">
                                ‚ÜîÔ∏è Flip X (Mirror)
                            </button>
                            <button id="flipYBtn" onclick="toggleFlip('flipY')" class="control-button px-3 py-2 rounded">
                                ‚ÜïÔ∏è Flip Y
                            </button>
                        </div>
                    </div>
                    <div id="imageControls" class="space-y-2 p-3 rounded-lg bg-[--color-section-bg]" style="display: none;">
                         <label for="scaleSlider" class="block text-sm font-medium text-white">
                            Item Scale: <span id="scaleValue">100%</span>
                        </label>
                        <input type="range" id="scaleSlider" min="0.2" max="3" step="0.01" value="1.0" class="w-full h-2 bg-[--color-accent] rounded-lg appearance-none cursor-pointer range-lg" oninput="updateItemScale(event.target.value)">
                    </div>
                </div>

            </div>

            <div class="sticky-footer flex flex-col space-y-2 mt-6">
                <button onclick="postToBaseApp()" class="control-button w-full py-3 font-bold rounded-lg shadow-lg bg-green-500 hover:bg-green-600 text-white primary-action-button">
                    üöÄ Post to BaseApp
                </button>
                <button onclick="downloadMeme(true)" class="primary-action-button control-button w-full py-3 font-bold rounded-lg shadow-lg bg-[--color-primary-action]">
                    ‚¨áÔ∏è Download BaseMeme
                </button>
            </div>


            <div id="templates-panel" class="secondary-panel">
                <div class="flex justify-between items-center border-b border-[--color-accent] pb-3 mb-4 sticky top-0 bg-[--color-dark-bg] z-50 pt-2">
                    <h2 class="text-xl font-bold text-[--color-accent]">üñºÔ∏è Background & Templates</h2>
                    <button onclick="closeSecondaryPanel()" class="text-white text-2xl p-2 rounded-full hover:bg-[--color-dark-accent]">&times;</button>
                </div>
                
                <div class="space-y-4 mb-6 p-3 rounded-lg bg-[--color-section-bg]">
                    <h3 class="text-lg font-bold text-white mb-3">Upload Custom</h3>
                    <input type="file" id="imageUploadInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                    <button onclick="document.getElementById('imageUploadInput').click(); state.uploadMode = 'background';" class="primary-action-button control-button w-full py-3 font-bold rounded-lg">
                        ‚¨ÜÔ∏è Upload & Set as Background
                    </button>
                    <button onclick="document.getElementById('imageUploadInput').click(); state.uploadMode = 'layer';" class="primary-action-button control-button w-full py-3 font-bold rounded-lg">
                        üñºÔ∏è Upload & Add as Layer
                    </button>
                </div>
                
                <h3 class="text-lg font-bold text-white mb-3">Select Template</h3>
                <div id="templateSelector" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
            </div>

            <div id="stickers-panel" class="secondary-panel">
                <div class="flex justify-between items-center border-b border-[--color-accent] pb-3 mb-4 sticky top-0 bg-[--color-dark-bg] z-50 pt-2">
                    <h2 class="text-xl font-bold text-[--color-accent]">‚ú® Select Sticker</h2>
                    <button onclick="closeSecondaryPanel()" class="text-white text-2xl p-2 rounded-full hover:bg-[--color-dark-accent]">&times;</button>
                </div>
                <div id="stickerSelector" class="grid grid-cols-3 gap-3"></div>
            </div>
            
            <div id="text-panel" class="secondary-panel">
                <div class="flex justify-between items-center border-b border-[--color-accent] pb-3 mb-4 sticky top-0 bg-[--color-dark-bg] z-50 pt-2">
                    <h2 class="text-xl font-bold text-[--color-accent]">üÖ∞Ô∏è Text Options</h2>
                    <button onclick="closeSecondaryPanel()" class="text-white text-2xl p-2 rounded-full hover:bg-[--color-dark-accent]">&times;</button>
                </div>
                <div class="space-y-4">
                    <button onclick="addTextLayer('NEW TEXT')" class="control-button w-full py-3 bg-[--color-accent] hover:bg-opacity-90 text-black font-bold rounded-lg">
                        ‚ûï Add New Text Layer
                    </button>
                    
                    <div id="textControls" class="space-y-4 p-3 rounded-lg bg-[--color-section-bg]" style="display: none;">
                        <h3 class="text-lg font-semibold text-white">Selected Text Layer:</h3>
                        <label for="currentTextContent" class="block text-sm font-medium text-white">Text Content</label>
                        <textarea id="currentTextContent" rows="3" placeholder="Enter text content..." class="w-full p-2 rounded bg-white text-black border border-black focus:ring-[--color-accent] focus:border-[--color-accent] mt-1" oninput="updateCurrentTextContent()"></textarea>
                        
                        <div>
                            <span class="block text-sm font-medium text-white mb-1">Font Family:</span>
                            <div id="fontSelector" class="flex flex-wrap gap-2"></div>
                        </div>
                        
                        <div class="flex flex-wrap items-center gap-3 mb-4">
                            <button id="boldBtn" onclick="toggleStyle('isBold')" class="control-button px-3 py-2 rounded">
                                <span class="font-black">B</span>
                            </button>
                            <button id="italicBtn" onclick="toggleStyle('isItalic')" class="control-button px-3 py-2 rounded">
                                <span class="italic">I</span>
                            </button>
                            <div class="flex items-center space-x-2 bg-white rounded px-2 py-1 border border-black">
                                <label for="textColorInput" class="text-xs text-black cursor-pointer">Color:</label>
                                <input type="color" id="textColorInput" value="#ffffff" class="w-8 h-8 rounded cursor-pointer" oninput="updateTextColor()">
                            </div>
                        </div>
                        
                        <div>
                            <span class="block text-sm font-medium text-white mb-1">Font Size:</span>
                            <select id="fontSizeSelect" onchange="updateFontSize()" class="control-button w-full p-2 rounded text-black">
                                <option value="40">Size: Small</option>
                                <option value="60" selected>Size: Medium</option>
                                <option value="80">Size: Large</option>
                                <option value="100">Size: Extra Large</option>
                                <option value="120">Size: Huge</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div id="drawing-panel" class="secondary-panel">
                 <div class="flex justify-between items-center border-b border-[--color-accent] pb-3 mb-4 sticky top-0 bg-[--color-dark-bg] z-50 pt-2">
                    <h2 class="text-xl font-bold text-[--color-accent]">‚úèÔ∏è Drawing Options</h2>
                    <button onclick="closeSecondaryPanel()" class="text-white text-2xl p-2 rounded-full hover:bg-[--color-dark-accent]">&times;</button>
                </div>
                <div id="drawingControls" class="space-y-4 p-3 rounded-lg bg-[--color-section-bg] border border-[--color-accent]">
                    <button id="drawingModeToggle" onclick="toggleDrawingMode()" class="control-button w-full py-2 font-bold rounded-lg bg-[--color-primary-action] text-white">
                        üî¥ Toggle Drawing Mode (OFF)
                    </button>
                     <div class="flex items-center justify-between gap-3">
                        <div class="flex items-center space-x-2 bg-white rounded px-2 py-1 border border-black">
                            <label for="drawColorInput" class="text-sm text-black cursor-pointer">Color:</label>
                            <input type="color" id="drawColorInput" value="#547cf4" class="w-8 h-8 rounded cursor-pointer" oninput="updateDrawingColor(event.target.value)">
                        </div>

                        <div class="flex items-center space-x-2">
                            <label for="drawSizeSelect" class="text-sm text-white">Size:</label>
                            <select id="drawSizeSelect" onchange="updateDrawingSize(event.target.value)" class="control-button p-2 rounded text-black">
                                <option value="5">Small</option>
                                <option value="15" selected>Medium</option>
                                <option value="30">Large</option>
                                <option value="50">Huge</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="drawBrushSelect" class="text-sm text-white block mb-1">Brush Style:</label>
                        <select id="drawBrushSelect" onchange="updateDrawingBrush(event.target.value)" class="control-button w-full p-2 rounded text-black">
                            <option value="line" selected>Line (Default)</option>
                            <option value="star">‚≠ê Star (Simulated)</option>
                            <option value="sparks">‚ú® Sparks (Simulated)</option>
                        </select>
                    </div>
                    <button onclick="clearDrawingLayer()" class="control-button w-full py-2 rounded text-black font-bold">
                        üßπ Clear Drawing Layer
                    </button>
                </div>
            </div>

        </div>
    </div>


<script>
    // --- SIMULATED BASE ACCOUNT SDK (IMPORTANT) ---
    const BaseAccountSDK = {
        isConnected: false,
        userInfo: null,
        connect: function() {
            this.userInfo = { 
                userId: 'baseUser123', 
                username: 'BasePoster', 
                baseAccountAddress: '0x123...BaseMemeWallet' 
            };
            this.isConnected = true;
            document.getElementById('baseAppStatus').textContent = `BaseApp Status: Connected as ${this.userInfo.username} (Wallet: ${this.userInfo.baseAccountAddress.substring(0, 6)}...)`;
            console.log('Base Account SDK: Connected to on-chain identity.');
        },
    };
    // -------------------------------------------


    // --- DATA DEFINITIONS & STATE MANAGEMENT ---
    const templates = [
        { id: 't1', name: 'Meme 1 (4:3)', url: './memes/meme1.png', defaultW: 600, defaultH: 450 },
        { id: 't2', name: 'Meme 2 (16:9)', url: './memes/meme2.png', defaultW: 600, defaultH: 337 },
        { id: 't3', name: 'Meme 3 (3:4)', url: './memes/meme3.png', defaultW: 450, defaultH: 600 },
        { id: 't4', name: 'Square (1:1)', url: './memes/meme4.png', defaultW: 600, defaultH: 600 },
        { id: 't5', name: 'Wide (9:5)', url: './memes/meme5.png', defaultW: 600, defaultH: 333 },
        { id: 't6', name: 'Meme 6 (1:1)', url: './memes/meme6.png', defaultW: 600, defaultH: 600 },
    ];

    const stickers = [
        { id: 's1', name: 'Base 1', url: './base/base1.png' },
        { id: 's2', name: 'Base 2', url: './base/base2.png' },
        { id: 's3', name: 'Base 3', url: './base/base3.png' },
        { id: 's4', name: 'Base 4', url: './base/base4.png' },
        { id: 's5', name: 'Base 5', url: './base/base5.png' },
        { id: 's6', name: 'Base 6', url: './base/base6.png' },
    ];

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã
    const fonts = [
        { id: 'f4', name: 'App Global', family: 'AppGlobalFont', url: './fonts/font4.otf', format: 'opentype' },
        { id: 'f1', name: 'Local Font 1', family: 'LocalFont1', url: './fonts/font1.ttf', format: 'truetype' },
        { id: 'f2', name: 'Local Font 2', family: 'LocalFont2', url: './fonts/font2.ttf', format: 'truetype' },
        { id: 'f3', name: 'Local Font 3', family: 'LocalFont3', url: './fonts/font3.ttf', format: 'truetype' }
    ];

    const canvas = document.getElementById('memeCanvas');
    const ctx = canvas.getContext('2d');
    const drawingCanvas = document.getElementById('drawingCanvas');
    const drawingCtx = drawingCanvas.getContext('2d');
    const canvasContainer = document.getElementById('canvas-container');
    const layerResizeHandle = document.getElementById('layerResizeHandle');
    const canvasResizeHandle = document.getElementById('resizeHandle');

    const MIN_CANVAS_SIZE = 100;
    const MAX_CANVAS_SIZE = 1200;
    const MIN_LAYER_SCALE = 0.1;

    let state = {
        selectedTemplateId: templates[0].id,
        currentTemplate: null,
        layers: [],
        selectedLayerIndex: -1,
        isDragging: false,
        isResizing: false, 
        isLayerResizing: false,
        dragStartX: 0,
        dragStartY: 0,
        stickerImages: {},
        templateImages: {},
        isDrawing: false,
        drawingMode: false,
        drawingColor: '#547cf4',
        drawingSize: 15,
        drawingBrush: 'line',
        lastX: 0,
        lastY: 0,
        isCustomBackground: false,
        uploadMode: 'background'
    };

    // --- INITIALIZATION: –ñ–î–ï–ú –ó–ê–ì–†–£–ó–ö–ò –®–†–ò–§–¢–û–í –ò –ö–û–ù–¢–ï–ù–¢–ê ---
    document.addEventListener('DOMContentLoaded', () => {
        BaseAccountSDK.connect(); 
        
        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤
        const fontPromises = fonts.map(font => {
            const fontFace = new FontFace(font.family, `url(${font.url})`);
            return fontFace.load()
                .then(loadedFace => {
                    document.fonts.add(loadedFace);
                    console.log(`–®—Ä–∏—Ñ—Ç "${font.name}" –∑–∞–≥—Ä—É–∂–µ–Ω.`);
                })
                .catch(error => {
                    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–∞ "${font.name}" –ø–æ –ø—É—Ç–∏ ${font.url}:`, error);
                });
        });

        Promise.allSettled(fontPromises).then(() => {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤...');

            let initialTemplate = templates.find(t => t.id === state.selectedTemplateId);
            canvas.width = initialTemplate.defaultW;
            canvas.height = initialTemplate.defaultH;

            // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
            renderTemplateSelector();
            renderStickerSelector();
            renderFontSelector();
            
            // 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const defaultFontId = fonts[0].id;
            loadTemplateImage(initialTemplate.url, initialTemplate.defaultW, initialTemplate.defaultH).then(() => {
                 addTextLayer('TOP TEXT', canvas.width / 2, 0.1 * canvas.height, defaultFontId);
                 addTextLayer('BOTTOM TEXT', canvas.width / 2, 0.9 * canvas.height, defaultFontId);
                 drawMeme(); 
            });

            document.getElementById('drawColorInput').value = state.drawingColor;
            document.getElementById('drawSizeSelect').value = state.drawingSize.toString();
            document.getElementById('drawBrushSelect').value = state.drawingBrush;
            resizeCanvases();
            setupCanvasInteractions(); 
            setupDrawingInteractions(); 
            setupCanvasResizingInteractions(); 
            setupLayerResizingInteractions(); 
            window.addEventListener('resize', resizeCanvases);
        });
    });
    // --- End Initialization ---

    // --- CORE LOGIC FUNCTIONS ---

    function resizeCanvases() {
        if (!canvas.width || !canvas.height) return;
        
        const previewElement = document.getElementById('preview');
        const containerWidth = previewElement.clientWidth;
        const containerHeight = previewElement.clientHeight;
        
        const maxDisplayWidth = containerWidth * 0.95;
        const maxDisplayHeight = containerHeight * 0.95;

        const scaleToFitWidth = maxDisplayWidth / canvas.width;
        const scaleToFitHeight = maxDisplayHeight / canvas.height;
        
        const scaleFactor = Math.min(scaleToFitWidth, scaleToFitHeight);

        drawingCanvas.width = canvas.width;
        drawingCanvas.height = canvas.height;
        drawingCanvas.style.width = `${canvas.width}px`;
        drawingCanvas.style.height = `${canvas.height}px`;

        canvasContainer.style.width = `${canvas.width}px`;
        canvasContainer.style.height = `${canvas.height}px`;
        canvasContainer.style.transform = `scale(${scaleFactor})`;

        updateDrawingContext();
        updateLayerResizeHandlePosition(); 
    }
    
    function updateLayerResizeHandlePosition() {
        const layer = state.layers[state.selectedLayerIndex];
        const handle = document.getElementById('layerResizeHandle');

        if (layer && layer.type === 'image') {
            const renderW = layer.imageObject.width * layer.scale * (layer.flipX ? -1 : 1);
            const renderH = layer.imageObject.height * layer.scale * (layer.flipY ? -1 : 1);
            
            let cornerX = layer.x + renderW / 2;
            let cornerY = layer.y + renderH / 2;
            
            let finalX = cornerX;
            let finalY = cornerY;
            
            if (layer.rotation !== 0) {
                 const angle = layer.rotation * Math.PI / 180;
                 const cos = Math.cos(angle);
                 const sin = Math.sin(angle);
                 
                 const tx = cornerX - layer.x;
                 const ty = cornerY - layer.y;
                 
                 finalX = layer.x + (tx * cos - ty * sin);
                 finalY = layer.y + (tx * sin + ty * cos);
            }

            handle.style.left = `${finalX}px`; 
            handle.style.top = `${finalY}px`; 
            handle.style.display = 'block';
        } else {
            handle.style.display = 'none';
        }
    }

    function drawMeme() {
        if (!state.currentTemplate) { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        else { ctx.drawImage(state.currentTemplate, 0, 0, canvas.width, canvas.height); }
        
        state.layers.forEach((layer, index) => {
            ctx.save();
            ctx.translate(layer.x, layer.y);
            ctx.rotate(layer.rotation * Math.PI / 180);
            
            const scaleX = layer.flipX ? -1 : 1;
            const scaleY = layer.flipY ? -1 : 1;
            ctx.scale(scaleX, scaleY);
            
            let drawWidth = 0; 
            let drawHeight = 0; 
            
            if (layer.type === 'text') {
                const fontConfig = fonts.find(f => f.id === layer.fontId);
                const fontFamily = fontConfig ? `'${fontConfig.family}', sans-serif` : 'sans-serif'; 
                const style = (layer.isBold ? 'bold ' : '') + (layer.isItalic ? 'italic ' : '');
                ctx.font = `${style}${layer.fontSize}px ${fontFamily}`;
                
                ctx.fillStyle = layer.color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = layer.fontSize / 15;
                const lines = layer.content.split('\n');
                let maxLineWidth = 0;
                let lineSpacing = layer.fontSize * 1.2;
                lines.forEach((line, i) => {
                    const yOffset = (i - (lines.length - 1) / 2) * lineSpacing;
                    ctx.strokeText(line, 0, yOffset); 
                    ctx.fillText(line, 0, yOffset);
                    maxLineWidth = Math.max(maxLineWidth, ctx.measureText(line).width);
                });
                drawWidth = maxLineWidth + ctx.lineWidth * 2;
                drawHeight = lines.length * lineSpacing + ctx.lineWidth * 2;
                
                if (index === state.selectedLayerIndex) {
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 4 / Math.min(Math.abs(scaleX), Math.abs(scaleY)); 
                    ctx.strokeRect(-drawWidth / 2 - 2, -drawHeight / 2 - 2, drawWidth + 4, drawHeight + 4);
                }
            } else if (layer.type === 'image') {
                const img = layer.imageObject;
                if (img && img.complete && img.naturalWidth !== 0) { 
                    const renderW = img.width * layer.scale;
                    const renderH = img.height * layer.scale;
                    ctx.drawImage(img, -renderW / 2, -renderH / 2, renderW, renderH);
                    drawWidth = renderW;
                    drawHeight = renderH;
                    
                    if (index === state.selectedLayerIndex) {
                        ctx.strokeStyle = 'red';
                        ctx.lineWidth = 4 / Math.min(Math.abs(scaleX), Math.abs(scaleY)); 
                        ctx.strokeRect(-drawWidth / 2 - 2, -drawHeight / 2 - 2, drawWidth + 4, drawHeight + 4);
                    }
                }
            }
            
            ctx.restore();
            
            // Recalculate Bounding Box
            if (layer.type === 'text' || (layer.type === 'image' && drawWidth > 0)) {
                const w = drawWidth;
                const h = drawHeight;
                const angle = layer.rotation * Math.PI / 180;
                const cos = Math.cos(angle);
                const sin = Math.sin(angle);
                
                const hw = w / 2;
                const hh = h / 2;
                
                const corners = [
                    { x: -hw * cos - hh * sin, y: -hw * sin + hh * cos },
                    { x: hw * cos - hh * sin, y: hw * sin + hh * cos },
                    { x: -hw * cos + hh * sin, y: -hw * sin - hh * cos },
                    { x: hw * cos + hh * sin, y: hw * sin - hh * cos }
                ];
                
                const minX = Math.min(...corners.map(c => c.x)) + layer.x;
                const maxX = Math.max(...corners.map(c => c.x)) + layer.x;
                const minY = Math.min(...corners.map(c => c.y)) + layer.y;
                const maxY = Math.max(...corners.map(c => c.y)) + layer.y;

                layer.bbox = { x: minX, y: minY, w: maxX - minX, h: maxY - minY };
            }
        });
        
        updateLayerResizeHandlePosition(); 
    }
    
    // --- CANVAS RESIZING (BLUE HANDLE) ---
    function setupCanvasResizingInteractions() { /* ... implementation omitted ... */ }
    function startResizing(e) { /* ... implementation omitted ... */ }
    function resizeCanvas(e) { /* ... implementation omitted ... */ }
    function stopResizing() { /* ... implementation omitted ... */ }
    
    // --- LAYER RESIZING (RED HANDLE) ---
    function setupLayerResizingInteractions() { /* ... implementation omitted ... */ }
    function startLayerResizing(e) { /* ... implementation omitted ... */ }
    function resizeLayer(e) { /* ... implementation omitted ... */ }
    function stopLayerResizing() { /* ... implementation omitted ... */ }

    // --- INTERACTIONS ---
    function getEventPos(e) { /* ... implementation omitted ... */ }
    function setupCanvasInteractions() { /* ... implementation omitted ... */ }
    function handleStart(e) { /* ... implementation omitted ... */ }
    function handleMove(e) { /* ... implementation omitted ... */ }
    function handleEnd() { /* ... implementation omitted ... */ }
    
    // --- UI/STATE ---
    function toggleMainDrawer() { /* ... implementation omitted ... */ }
    function openSecondaryPanel(panelId) { /* ... implementation omitted ... */ }
    function closeSecondaryPanel() { /* ... implementation omitted ... */ }

    function updateControlPanel(forceUpdate = false) {
        const index = state.selectedLayerIndex;
        const layer = state.layers[index];
        
        const commonControls = document.getElementById('commonControls');
        const transformationControls = document.getElementById('transformationControls');
        const layerTypeDisplay = document.getElementById('currentLayerTypeDisplay');
        const textControls = document.getElementById('textControls');
        const imageControls = document.getElementById('imageControls');
        
        commonControls.classList.add('hidden');
        transformationControls.classList.add('hidden');
        layerTypeDisplay.textContent = 'None';
        textControls.style.display = 'none';
        imageControls.style.display = 'none';
        layerResizeHandle.style.display = 'none';
        
        if (index >= 0 && layer) {
            commonControls.classList.remove('hidden');
            transformationControls.classList.remove('hidden');
            layerTypeDisplay.textContent = `${layer.type.charAt(0).toUpperCase() + layer.type.slice(1)} Layer ${index + 1}`;
            
            document.getElementById('rotationSlider').value = layer.rotation;
            document.getElementById('rotationValue').textContent = `${layer.rotation}¬∞`;
            document.getElementById('flipXBtn').classList.toggle('selected-item', layer.flipX);
            document.getElementById('flipYBtn').classList.toggle('selected-item', layer.flipY);
            
            if (layer.type === 'text') {
                textControls.style.display = 'block';
                document.getElementById('currentTextContent').value = layer.content;
                document.getElementById('textColorInput').value = layer.color;
                document.getElementById('fontSizeSelect').value = layer.fontSize.toString();
                document.getElementById('boldBtn').classList.toggle('selected-item', layer.isBold);
                document.getElementById('italicBtn').classList.toggle('selected-item', layer.isItalic);
                renderFontSelector();
            } else if (layer.type === 'image') {
                imageControls.style.display = 'block';
                document.getElementById('scaleSlider').value = layer.scale;
                document.getElementById('scaleValue').textContent = `${Math.round(layer.scale * 100)}%`;
            }
        }
        updateLayerResizeHandlePosition(); 
    }

    // --- RENDERERS ---
    
    function renderTemplateSelector() {
        const container = document.getElementById('templateSelector');
        container.innerHTML = '';
        
        templates.forEach(template => {
            let imgObject = state.templateImages[template.id];
            
            if (!imgObject || imgObject === 'loading') {
                imgObject = new Image();
                imgObject.onload = () => {
                    state.templateImages[template.id] = imgObject;
                    renderTemplateSelector(); 
                };
                imgObject.onerror = () => { console.warn(`Could not load template image for: ${template.name}`); };
                imgObject.src = template.url;
                state.templateImages[template.id] = 'loading';
                // Placeholder rendering when loading
                const placeholder = document.createElement('div');
                placeholder.className = 'control-button p-2 rounded-lg relative w-full aspect-square flex justify-center items-center bg-[--color-section-bg] text-sm text-white';
                placeholder.textContent = 'Loading...';
                container.appendChild(placeholder);
            } else {
                const button = document.createElement('button');
                button.className = `control-button p-2 rounded-lg relative w-full aspect-square flex flex-col justify-center items-center overflow-hidden ${state.selectedTemplateId === template.id && !state.isCustomBackground ? 'selected-item' : ''}`;
                button.onclick = () => selectTemplate(template.id);
                
                const img = document.createElement('img');
                img.src = template.url;
                img.alt = template.name;
                img.className = 'w-full h-auto object-cover absolute inset-0';

                const nameTag = document.createElement('div');
                nameTag.textContent = template.name;
                nameTag.className = 'absolute bottom-0 w-full text-xs bg-black bg-opacity-50 text-white p-1 truncate';

                button.appendChild(img);
                button.appendChild(nameTag);
                container.appendChild(button);
            }
        });
    }

    function renderStickerSelector() {
        const container = document.getElementById('stickerSelector');
        container.innerHTML = '';
        stickers.forEach(sticker => {
            const button = document.createElement('button');
            button.className = 'control-button p-2 rounded-lg';
            button.onclick = () => addPresetImageLayer(sticker.url, sticker.id);
            
            const img = document.createElement('img');
            img.src = sticker.url;
            img.alt = sticker.name;
            img.className = 'w-full h-auto max-h-20 object-contain';

            button.appendChild(img);
            container.appendChild(button);
        });
    }

    function renderFontSelector() {
        const container = document.getElementById('fontSelector');
        container.innerHTML = '';
        const currentLayer = state.layers[state.selectedLayerIndex];
        
        fonts.forEach(font => {
            const button = document.createElement('button');
            button.textContent = font.name;
            button.className = `control-button px-3 py-1 rounded text-sm ${currentLayer?.fontId === font.id ? 'selected-item' : ''}`;
            button.style.fontFamily = `'${font.family}', sans-serif`;
            button.onclick = () => updateFontFamily(font.id);
            container.appendChild(button);
        });
    }

    // --- LAYER MANIPULATION ---

    function loadTemplateImage(url, targetW, targetH) { /* ... implementation omitted ... */ }
    function loadCustomTemplateImage(url) { /* ... implementation omitted ... */ }
    function selectTemplate(id) { /* ... implementation omitted ... */ }
    function createImageLayerObject(url, imgObject, name = '') { /* ... implementation omitted ... */ }
    
    function addTextLayer(content = 'New Text', x = canvas.width / 2, y = canvas.height / 2, fontId = fonts[0].id) {
        const newLayer = {
            type: 'text', id: Date.now(), content: content.toUpperCase(),
            x: x, y: y, isBold: content.includes('TOP') || content.includes('BOTTOM') ? true : false,
            isItalic: false, fontSize: 60, color: '#FFFFFF', fontId: fontId,
            rotation: 0, flipX: false, flipY: false, bbox: { x: 0, y: 0, w: 0, h: 0 }
        };
        state.layers.push(newLayer);
        state.selectedLayerIndex = state.layers.length - 1;
        updateControlPanel(true);
        drawMeme();
    }
    
    function addPresetImageLayer(url, id) { /* ... implementation omitted ... */ }
    function handleImageUpload(event) { /* ... implementation omitted ... */ }
    function addImageLayer(url, name) { /* ... implementation omitted ... */ }

    // --- CONTROLS ---
    function updateItemScale(scale) { /* ... implementation omitted ... */ }
    function updateRotation(degrees) { /* ... implementation omitted ... */ }
    function toggleFlip(axis) { /* ... implementation omitted ... */ }
    function deleteSelectedLayer() { /* ... implementation omitted ... */ }

    // --- TEXT CONTROLS ---
    function updateCurrentTextContent() { /* ... implementation omitted ... */ }
    function updateFontFamily(fontId) { /* ... implementation omitted ... */ }
    function updateFontSize() { /* ... implementation omitted ... */ }
    function updateTextColor() { /* ... implementation omitted ... */ }
    function toggleStyle(style) { /* ... implementation omitted ... */ }

    // --- DRAWING CONTROLS ---
    function updateDrawingContext() { /* ... implementation omitted ... */ }
    function setupDrawingInteractions() { /* ... implementation omitted ... */ }
    function startDrawing(e) { /* ... implementation omitted ... */ }
    function draw(e) { /* ... implementation omitted ... */ }
    function stopDrawing() { /* ... implementation omitted ... */ }
    function toggleDrawingMode() { /* ... implementation omitted ... */ }
    function updateDrawingColor(color) { /* ... implementation omitted ... */ }
    function updateDrawingSize(size) { /* ... implementation omitted ... */ }
    function updateDrawingBrush(brush) { /* ... implementation omitted ... */ }
    function clearDrawingLayer() { /* ... implementation omitted ... */ }

    // --- FINAL ACTIONS ---
    function downloadMeme(showAlert = false) { /* ... implementation omitted ... */ }
    async function postToBaseApp() { /* ... implementation omitted ... */ }
</script>
</body>
</html>
